<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head>  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>  <title>处理记录</title>  <!-- css -->  <!--[if lt IE 9]>  <script src="/epms/biz/js/html5shiv.min.js"></script>  <![endif]-->  <link rel="stylesheet" type="text/css" href="/epms/theme/css/common.css"/>  <link rel="stylesheet" type="text/css" href="/epms/theme/css/zzsc.css"/>  <link rel="stylesheet" type="text/css" href="/epms/theme/css/content.css"/>  <link rel="stylesheet" type="text/css" href="/epms/plugins/ext/resources/css/ext-all.css"/>  <link rel="stylesheet" type="text/css" href="/epms/plugins/ext/resources/css/xtheme-gray.css"/>  <link rel="stylesheet" type="text/css" href="/epms/theme/css/oaTab.css"/>  <link rel="stylesheet" type="text/css" href="/epms/theme/css/wui.css">  <link rel="stylesheet" type="text/css" href="/epms/theme/css/font-awesome.min.css">  <link rel="stylesheet" type="text/css" href="/epms/plugins/jquery/tip/style.css"/>  <link rel="stylesheet" type="text/css" href="/epms/theme/css/introjs.css"/>  <link rel="stylesheet" type="text/css" href="/epms/plugins/jbox/Blue/jbox.css"/>  <script type="text/javascript" src="/epms/plugins/ext/adapter/ext/ext-base.js"></script>  <script type="text/javascript" src="/epms/plugins/ext/ext-all-debug.js"></script>  <script type="text/javascript" src="/epms/plugins/ext/ext-lang-zh_CN.js"></script>  <script type="text/javascript" src="/epms/plugins/ext/ext-patch.js"></script>  <script type="text/javascript" src="/epms/plugins/ext/ux/JsonTreeLoader.js"></script>  <script type="text/javascript" src="/epms/plugins/ext/ux/TreeCheckNodeUI.js"></script>  <script type="text/javascript" src="/epms/plugins/ext/ux/SearchField.js"></script>  <script type="text/javascript" src="/epms/theme/laydate/laydate.js"></script>  <script type="text/javascript" src="/epms/plugins/layui-v2.4.5/layui/layui.js"></script>  <script type="text/javascript" src="/epms/plugins/jquery/jquery.js"></script>  <script type="text/javascript" src="/epms/plugins/jquery/jquery.ajaxform.js"></script>  <script type="text/javascript" src="/epms/plugins/jquery/tip/jquery.simpletip.js"></script>  <script type="text/javascript" src="/epms/plugins/jbox/jquery.jBox-2.3.min.js"></script>  <script type="text/javascript" src="/epms/plugins/jbox/i18n/jquery.jBox-zh-CN.js"></script>  <script type="text/javascript" src="/epms/biz/js/verify.js"></script>  <script type="text/javascript" src="/epms/biz/js/jquery.form.validator.js"></script>  <script type="text/javascript" src="/epms/biz/js/jquery.plugin.epms.js"></script>  <script type="text/javascript" src="/epms/biz/js/ext-boco-plugins.js"></script>  <script type="text/javascript" src="/epms/biz/js/wui.js"></script>  <script type="text/javascript" src="/epms/biz/js/jquery.pagination.js"></script>  <script type="text/javascript" src="/epms/biz/js/common.js"></script>  <script type="text/javascript" src="/epms/biz/js/intro.js"></script>  <script type="text/javascript" src="/epms/biz/js/honest/forTheLichKing.js"></script>  <script language="javascript" type="text/javascript" src="/epms/plugins/jquery/DatePicker/WdatePicker.js"></script>  <script type="text/javascript">    Ext.BLANK_IMAGE_URL = "/epms/plugins/ext/resources/images/default/s.gif";    Ext.data.Connection.prototype.timeout = '90000';    Ext.QuickTips.init();  </SCRIPT>  <script type="text/javascript" src="/epms/plugins/ext/raphael-min.js"></script>  <script type="text/javascript">    (function init() {      //设置流程图的宽度      initWidth = 40;      //设置流程图的高度      intiHeight = 40;      //节点x坐标到图形左边框的距离      toLeft = Math.floor(1 / 3 * initWidth);      //节点x坐标到图形右边框的距离      toRight = Math.floor(2 / 3 * initWidth);      //节点y坐标距离图形上边框的距离      toTop = Math.floor(1 / 3 * intiHeight);      //节点y坐标距离图形下边框的距离      toBotom = Math.floor(2 / 3 * intiHeight);      //流程图距离（0,0）点的默认位置      chartInitX = 60;      chartInitY = 60;    })();    function asc(a, b) {      return a - b;    }    //获取流程图相对于（0,0）点的偏移量    function getOffSetXANDY4Chart(source) {      //存储流程图中所有的x坐标      var xArray = new Array();      //存储流程图中所有的y坐标      var yArray = new Array();      if (source) {        var index = 0;        $.each(source, function (i, node) {          //获取到所有节点的坐标          xArray[index] = node.xPoint;          yArray[index] = node.yPoint;          ++index;          var linkCounts = node.linkCounts;          if (linkCounts && linkCounts > 0) {            //获取到节点下所有连线的坐标            for (var l = 0; l < linkCounts; l++) {              var link = node["link" + l];              var pointCounts = 0;              if (link) {                pointCounts = link.pointCounts;              }              if (pointCounts > 0) {                for (var p = 0; p < pointCounts; p++) {                  var point = link["point" + p];                  if (point) {                    xArray[index] = point.x;                    yArray[index] = point.y;                    ++index;                  }                }              }            }          }        })      }      xArray.sort(asc);      yArray.sort(asc);      if (xArray[0] && xArray[0] > chartInitX) {        //流程图x的偏移距离        chartInitX = xArray[0] - chartInitX;      } else {        //如果流程图的x<=默认位置，那么不对流程图的位置坐任何调整        chartInitX = 0;      }      if (yArray[0] && yArray[0] > chartInitY) {        //流程图y的偏移距离        chartInitY = yArray[0] - chartInitY;      } else {        //如果流程图的y<=默认位置，那么不对流程图的位置坐任何调整        chartInitY = 0;      }      var offSettXORY = {        offSetX: chartInitX,        offSetY: chartInitY,        canvasWidth: xArray[xArray.length - 1] * 1 + initWidth - chartInitX,        canvasHeight: yArray[yArray.length - 1] * 1 + intiHeight - chartInitY      };      delete xArray;      delete yArray;      return offSettXORY;    }    //对连线的终点坐标进行调整    function adjustLastPoint(obj) {      var x1 = obj.lastPoint.x;      var y1 = obj.lastPoint.y;      var x2 = obj.secondLastPoint.x;      var y2 = obj.secondLastPoint.y;      var x = 0;      var y = 0;      if (x2 < x1 && y1 == y2) {        //从左到右        y = y1;        x = x1 - toLeft - 5;      } else if (x2 > x1 && y1 == y2) {        //从右边到左边        y = y1;        x = x1 * 1 + toRight;      } else if (x1 == x2 && y1 > y2) {        //垂直向下        x = x1;        y = y1 - toTop;      } else if (x1 == x2 && y1 < y2) {        //垂直向上        x = x1;        y = y1 * 1 + toBotom;      }      else {        if (Math.abs(x1 - x2) <= Math.abs(y1 - y2)) {          //x一定          x = x1;          if (y1 - y2 > 0) {            //点在上方            y = y1 * 1 - toTop - 5;          } else {            //点在下方            y = y1 * 1 + toBotom;          }        } else {          //y一定          y = y1;          if (x1 - x2 > 0) {            //点在左方            x = x1 - toLeft - 5;          } else {            //点在右方            x = x1 * 1 + toRight          }        }      }      //终点坐标      var newLastPoint = {        lastPointX: x,        lastPointY: y      };      delete x;      delete y;      return newLastPoint;    }    //组装连线及箭头信息    function getArrow(obj, size) {      var pointCounts = obj.pointCounts;      var lastSecondPoint = obj["point" + (pointCounts - 2)];      var lastPoint = obj["point" + (pointCounts - 1)];      var param = {        lastPoint: lastPoint,        secondLastPoint: lastSecondPoint      };      //调整连线的终点坐标      var newLastPoint = adjustLastPoint(param);      lastPoint.x = newLastPoint.lastPointX - offSetPoint.offSetX;      lastPoint.y = newLastPoint.lastPointY - offSetPoint.offSetY;      var angle = Raphael.angle((lastSecondPoint.x - offSetPoint.offSetX), (lastSecondPoint.y - offSetPoint.offSetY), lastPoint.x, lastPoint.y);//得到两点之间的角度      var a45 = Raphael.rad(angle - 45);//角度转换成弧度      var a45m = Raphael.rad(angle + 45);      var x2a = Math.floor(lastPoint.x * 1 + Math.cos(a45) * size);      var y2a = Math.floor(lastPoint.y * 1 + Math.sin(a45) * size);      var x2b = Math.floor(lastPoint.x * 1 + Math.cos(a45m) * size);      var y2b = Math.floor(lastPoint.y * 1 + Math.sin(a45m) * size);      //构建路径      var mapPath = "M,";      for (var i = 0; i < pointCounts - 1; i++) {        var point = obj["point" + i];        mapPath += (point.x - offSetPoint.offSetX) + "," + (point.y - offSetPoint.offSetY) + ",L,"      }      mapPath += lastPoint.x + "," + lastPoint.y + "," + x2a + "," + y2a + "," + "M," + lastPoint.x + "," + lastPoint.y + ",L," + x2b + "," + y2b;      var result = mapPath.split(",");      return result;    }    //自定义画箭头的方法    Raphael.fn.drawArrow = function (obj) {      var instance = {};      var path1 = getArrow(obj, 8);      instance.arrPath = this.path(path1);      return instance;    }    //画审批角色名称    function drawNodeText(obj, raphael) {      var obj = raphael.text(obj.x + 30, obj.y + 50, obj.text);      obj.attr({fill: "#2A00FF"});    }    //关闭节点信息    function closePhotoInfo() {      $(".photoInfo").html('');    }    //显示节点信息    function showNodeInfo(obj, n) {      //经过挪动后的node的新的位置      var adjustNodeX = n.xPoint - offSetPoint.offSetX;      var adjustNodey = n.yPoint - offSetPoint.offSetY;      var arr = new Array();      arr.push('<div style="background-color:#7EBB38">');      arr.push('<p>' + n.tipInfo + '<br/>');      arr.push('</p>');      arr.push('</div>');      arr.push('<div class="pic_float_jt"></div>');      $(".photoInfo").css("position", "absolute");      $(".photoInfo").offset({top: adjustNodey - 50, left: adjustNodeX - 50});      $(".photoInfo").html(arr.join(""));    }    //获取节点类型    function getNodeImageSrc(n) {      //1.png:开始;2.png:已审批;3.png:正在审批;4.png:没有审批；5.png:结束      var srcType = "01.png";      var nodeType = n.nodeType * 1;      if (nodeType == 4) {        //开始        srcType = "01.png";      } else if (nodeType == 5) {        //结束        srcType = "05.png";      } else if (nodeType == 1) {        if (n.nodeState == 'yes') {          //已经审批          srcType = "02.png";        } else if (n.nodeState == 'no') {          //当前审批          srcType = "03.png";        } else {          //未审批          srcType = "04.png";        }      }      return srcType;    }    //画节点    function drawNode(node, raphael) {      //获取节点类型      var imageSrc = "/epms/theme/images/liucheng/" + getNodeImageSrc(node);      //经过挪动后的node的新的位置      var adjustNodeX = node.xPoint - offSetPoint.offSetX;      var adjustNodey = node.yPoint - offSetPoint.offSetY;      //画节点      var imageNode = raphael.image(imageSrc, adjustNodeX * 1, adjustNodey * 1, initWidth, intiHeight);      //为节点添加动作      if (node.nodeState) {        imageNode.mouseover(function () {          showNodeInfo(imageNode, node);        });        imageNode.mouseout(function () {          closePhotoInfo();        });      }    }    //为连线填充颜色    function fillColor4Link(instance, color) {      instance.arrPath.attr({fill: color, stroke: color, "fill-opacity": 0, "stroke-width": 2});    }    //获取到node上连线的颜色    function getLinkFillColor(link, node) {      var linkColor = "red";      if (link.linkType == 1) {        //回退        linkColor = "#00FF00";      } else if (link.linkType == 0) {        //如果是开始节点上的连线；判断是否流程已经启动        if (node.isBegin == "1") {          //开始节点(流程已经启动)          if (node.nodeType == 4) {            linkColor = "#529d2f";          } else if (node.nodeState == 'yes') {            //几点审批完成            linkColor = "#529d2f";          } else {            linkColor = "#CACACA";          }        } else {          //开始节点(流程未启动)          if (node.nodeType == 4) {            linkColor = "#529d2f";          } else {            linkColor = "#CACACA";          }        }      }      return linkColor;    }    //画节点间的连线    function drawLink(node, raphael) {      if (node.linkCounts && node.linkCounts > 0) {        var linkCounts = node.linkCounts * 1;        for (var i = 0; i < linkCounts; i++) {          var link = node["link" + i];          //画箭头和连线          var instance = raphael.drawArrow(link);          //获取连线的填充颜色          var linkColor = getLinkFillColor(link, node);          //为联系填充颜色          fillColor4Link(instance, linkColor);        }      }    }    //获取对流程图的描述信息    function getImageSource() {      var imageSourceText = $("#imageSource").html();      if (imageSourceText) {        return eval("(" + imageSourceText + ")");      } else {        $("#canvasDiv").html("请刷新");        return "";      }    }    //画节点，并返回节点的集合    function drawImage(raphael, source) {      if (source) {        $.each(source, function (i, node) {          //画线          drawLink(node, raphael);          //画节点          drawNode(node, raphael)          //经过挪动后的node的新的位置          var adjustNodeX = node.xPoint - offSetPoint.offSetX;          var adjustNodey = node.yPoint - offSetPoint.offSetY;          //画节点的名称          drawNodeText({x: adjustNodeX * 1, y: adjustNodey * 1, text: node.nodeName}, raphael);        })      }    }    window.onload = function () {      //获取对图的描述信息      var source = getImageSource();      //获取流程图的偏移量      offSetPoint = getOffSetXANDY4Chart(source);      //创建画布      var raphael = Raphael("canvasDiv", $(window).width(), $(window).height());//         var raphael = Raphael("canvasDiv", offSetPoint.canvasWidth, offSetPoint.canvasHeight);      //画图      drawImage(raphael, source);    }  </script></head><body><div id="canvasDiv" style="background-color:#FFFEFF;"></div><p id="imageSource" style="display:none">  {"node1":{"xPoint":"207","yPoint":"205","nodeId":"85710979","nodeName":"开始","nodeType":"4","child0":{"linkId":"176960380","linkName":"","linkType":"0","startNode":"85710979","aimNode":"21329673","point0":{"x":"224","y":"222"}},"link0":{"linkId":"176960380","linkName":"","linkType":"0","startNode":"85710979","aimNode":"21329673","point0":{"x":"224","y":"222"},"point1":{"x":"370","y":"222"},"pointCounts":2},"linkCounts":1,"childCounts":0},"node2":{"xPoint":"353","yPoint":"205","nodeId":"21329673","nodeName":"拟稿人","nodeType":"1","nodeState":"yes","isBegin":"1","tipInfo":"参与办理人员：任超","child0":{"linkId":"890938839","linkName":"","linkType":"0","startNode":"21329673","aimNode":"93930686","point0":{"x":"370","y":"222"}},"link0":{"linkId":"890938839","linkName":"","linkType":"0","startNode":"21329673","aimNode":"93930686","point0":{"x":"370","y":"222"},"point1":{"x":"553","y":"221"},"pointCounts":2},"linkCounts":1,"childCounts":0},"node3":{"xPoint":"536","yPoint":"204","nodeId":"93930686","nodeName":"州市分公司部门领导审批","nodeType":"1","nodeState":"no","isBegin":"1","tipInfo":"当前办理人员：任超","child0":{"linkId":"97374062","linkName":"","linkType":"0","startNode":"93930686","aimNode":"53321488","point0":{"x":"553","y":"221"}},"link0":{"linkId":"97374062","linkName":"","linkType":"0","startNode":"93930686","aimNode":"53321488","point0":{"x":"553","y":"221"},"point1":{"x":"709","y":"222"},"pointCounts":2},"child1":{"linkId":"577671592","linkName":"","linkType":"1","startNode":"93930686","aimNode":"21329673","point0":{"x":"553","y":"221"},"point1":{"x":"529","y":"210"}},"link1":{"linkId":"577671592","linkName":"","linkType":"1","startNode":"93930686","aimNode":"21329673","point0":{"x":"553","y":"221"},"point1":{"x":"529","y":"210"},"point2":{"x":"370","y":"222"},"pointCounts":3},"linkCounts":2,"childCounts":0},"node4":{"xPoint":"692","yPoint":"205","nodeId":"53321488","nodeName":"州市分公司分管领导","nodeType":"1","nodeRoleName":"分公司副总经理","child0":{"linkId":"1003369013","linkName":"","linkType":"0","startNode":"53321488","aimNode":"90758566","point0":{"x":"709","y":"222"}},"link0":{"linkId":"1003369013","linkName":"","linkType":"0","startNode":"53321488","aimNode":"90758566","point0":{"x":"709","y":"222"},"point1":{"x":"865","y":"222"},"pointCounts":2},"child1":{"linkId":"212715787","linkName":"","linkType":"1","startNode":"53321488","aimNode":"21329673","point0":{"x":"709","y":"222"},"point1":{"x":"660","y":"178"}},"link1":{"linkId":"212715787","linkName":"","linkType":"1","startNode":"53321488","aimNode":"21329673","point0":{"x":"709","y":"222"},"point1":{"x":"660","y":"178"},"point2":{"x":"370","y":"222"},"pointCounts":3},"linkCounts":2,"childCounts":0},"node5":{"xPoint":"848","yPoint":"205","nodeId":"90758566","nodeName":"计划部项目经理审批","nodeType":"1","nodeRoleName":"计划部项目经理","child0":{"linkId":"2121695522","linkName":"","linkType":"0","startNode":"90758566","aimNode":"14467124","point0":{"x":"865","y":"222"}},"link0":{"linkId":"2121695522","linkName":"","linkType":"0","startNode":"90758566","aimNode":"14467124","point0":{"x":"865","y":"222"},"point1":{"x":"1013","y":"222"},"pointCounts":2},"child1":{"linkId":"544543706","linkName":"","linkType":"1","startNode":"90758566","aimNode":"21329673","point0":{"x":"865","y":"222"},"point1":{"x":"789","y":"114"}},"link1":{"linkId":"544543706","linkName":"","linkType":"1","startNode":"90758566","aimNode":"21329673","point0":{"x":"865","y":"222"},"point1":{"x":"789","y":"114"},"point2":{"x":"370","y":"222"},"pointCounts":3},"linkCounts":2,"childCounts":0},"node6":{"xPoint":"996","yPoint":"205","nodeId":"14467124","nodeName":"结束","nodeType":"5","linkCounts":0,"childCounts":0}}</p><div class="photoInfo"></div></body></html>